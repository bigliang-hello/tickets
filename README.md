## 约束与目标
- 框架：Taro.js（React+TS），目标端微信小程序，兼容 H5 调试。
- 票面：仅使用手绘风格图片作为背景（先用占位图），文本层绝对定位叠加，不使用 Canvas。
- OCR：采用腾讯云 OCR 免费版；当前无云函数环境，优先实现客户端直签调用（个人开发用），后续可替换为后端代理。

## 页面与组件
- Pages：`pages/index`（列表）、`pages/add`（添加：短信/截图/手动）、`pages/detail`（详情编辑/删除/分享）。
- Components：
  - TicketCard：背景图片 + 文本层锚点（% 坐标）+ 自适应字号/折行。
  - SMSParserInput：短信粘贴解析与预填预览。
  - ImageOCRUploader：选图、发起 OCR、展示识别文本与字段映射。
  - StationPicker：车次+日期查询经停站，选择目的地并自动填充到达时间。

## 数据与存储
- Ticket 模型：`id/trainCode/fromStationName&Code/toStationName&Code/departDate/departTime/arriveTime/seatCar/seatNo/seatType/gate/price/sourceType/rawText/imageUrl/notes/createdAt/updatedAt`。
- 本地存储为主；经停站按车次+日期缓存；后续可加云同步开关。

## 手绘票样（占位图）
- 首版使用占位图；定义文本锚点坐标为百分比，保证不同屏幕缩放下的稳定排版。
- 站名溢出处理：折行或缩小字号；时间/座位优先单行。

## 短信识别
- 标准化：清洗噪声、半角/全角统一、空格处理。
- 规则库（示例）
  - 车次：`([GDFZTK]\d{1,4})`
  - 日期：`(\d{4}-\d{2}-\d{2})|(\d{1,2}月\d{1,2}日)` → `YYYY-MM-DD`
  - 开车时间：`(\d{1,2}:\d{2})`（结合“开/发”词）
  - 站点：结合“从/至/到/站”等上下文提取中文站名（`[\u4e00-\u9fa5]{2,}`）
  - 座位：`(\d{1,2})车(\d{1,3})([A-F])座|座位号(\d{1,2})车(\d{1,3})([A-F])`
  - 检票口：`检票口\s*([A-Z]?\d{1,2})`
- 未识别项由用户补齐；识别到车次+日期后拉取经停站列表并自动填充到达时间。

## 截图 OCR（无云函数直签方案）
- 前端流程：`Taro.chooseImage` → 压缩/裁剪 → 以 Base64 形式调用腾讯云 OCR 通用文本（GeneralBasicOCR/GeneralFastOCR）。
- 安全与密钥管理：
  - 在「设置页」让用户手动输入 `SecretId/SecretKey`（仅保存在本地设备存储，不上传）。
  - 仅用于个人开发与测试；正式发布需改为后端代理或云函数，避免泄漏风险。
- 客户端签名实现：
  - 使用 TC3-HMAC-SHA256 签名规范构造 Canonical Request、StringToSign，生成 Authorization 头。
  - 请求头包含：`X-TC-Action=GeneralBasicOCR`、`X-TC-Version=2018-11-19`、`X-TC-Timestamp`、`X-TC-Region` 等。
  - 请求体：`ImageBase64` 或 `ImageUrl`（优先 Base64）。
- 失败回退：展示 OCR 文本并允许用户手动标注映射至字段。

## 12306 集成
- 经停站：以车次+日期查询当日经停站与到/发时刻，供 StationPicker 选择目的地与自动填充到达时间。
- 站点编码：将城市/站名转换为 `station_code` 存储以保证一致性。
- 缓存与降级：接口失败允许手动输入；结果按车次+日期缓存。

## 校验、错误与隐私
- 校验：日期/时间/座位格式与站点合法性；错误聚合提示。
- 隐私：票据数据仅本地存储；OCR 图片不持久化（处理后即丢弃，可配置）。
- 错误处理：接口/OCR/解析失败不阻断，保留已填数据并支持重试。

## 测试与验证
- 单元测试：规则库多模板覆盖、日期规范化、站点映射。
- 集成测试：OCR→解析→预填链路；经停站选择→到达时间自动填充。
- 视觉测试：占位图票面在不同尺寸的排版快照。

## 迭代步骤
- 初始化页面与存储；完成 TicketCard（占位图+文本层）与列表。
- 短信解析与表单预填；接入经停站选择与到达时间填充。
- 接入腾讯云 OCR 客户端直签；实现失败回退与统一解析。
- 完成详情/编辑/删除与分享；完善校验/错误/隐私；补齐测试。

## 待确认
- 是否接受「客户端直签（个人开发调试）」作为当前无云函数的临时方案？我将实现设置页管理密钥并明确风险提示；后续再切换到后端代理。
- 占位图是否由您提供或由我先放一张通用风格图？我会预留坐标锚点以便后续替换。